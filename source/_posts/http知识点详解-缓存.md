---
title: http知识点详解 - 缓存
date: 2020-10-29 17:31:38
tags:
- http
- 缓存
categories: 网络知识
---

浏览器HTTP缓存可以分为`强缓存`和`协商缓存`。强缓存和协商缓存最大也是最根本的区别是：强缓存命中的话不会发请求到服务器（比如chrome中的200 from memory cache），协商缓存一定会发请求到服务器，通过资源的请求首部字段验证资源是否命中协商缓存，如果协商缓存命中，服务器会将这个请求返回，但是不会返回这个资源的实体，而是通知客户端可以从缓存中加载这个资源（304 not modified）。简略流程图如下：
![](https://tva1.sinaimg.cn/large/0081Kckwly1gk7d2yb7loj30f20or74h.jpg)

<!--more-->

# 控制强缓存的字段

## Cache-Control
`Cache-Control`是一个通用首部字段，也是HTTP/1.1控制浏览器缓存的`主流字段`。和浏览器缓存相关的是如下几个响应指令：

|  指令 | 参数 | 说明 |
| -- | -- | -------- |
| private | 无 | 表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）|
| public  | 可省略 | 表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存 |
| no-cache | 可省略 | 缓存前必需确认其有效性 |
| no-store | 无 | 不缓存请求或响应的任何内容 |
| max-age=[s] | 必需 | 响应的最大值 |


1. `max-age（单位为s）`设置缓存的存在时间，相对于`发送请求的时间`。只有响应报文首部设置`Cache-Control`为非0的`max-age`或者设置了大于请求日期的`Expires`（下文会讲）才有可能命中强缓存。当满足这个条件，同时响应报文首部中`Cache-Control`不存在`no-cache`、`no-store`且请求报文首部不存在`Pragma`字段，才会真正命中强缓存
2. `no-cache`  表示请求必须先与服务器确认缓存的有效性，如果有效才能使用缓存（协商缓存），无论是响应报文首部还是请求报文首部出现这个字段均一定不会命中强缓存。Chrome硬性重新加载（Command+shift+R）会在请求的首部加上Pragma：no-cache和Cache-Control：no-cache。
3. `no-store`  表示禁止浏览器以及所有中间缓存存储任何版本的返回响应，一定不会出现强缓存和协商缓存，适合个人隐私数据或者经济类数据。
4. `public` 表明响应可以被浏览器、CDN等等缓存。
5. `private` 响应只作为私有的缓存，不能被CDN等缓存。如果要求HTTP认证，响应会自动设置为private。

## Expires
是一个响应首部字段，它指定了一个日期/时间，在这个时间/日期之前，HTTP缓存被认为是有效的。无效的日期比如0，表示这个资源已经过期了。如果同时设置了Cache-Control响应首部字段的max-age，则Expires会被忽略。它也是HTTP/1.1之前版本遗留的通用首部字段，仅作为于HTTP/1.0的向后兼容而使用。

# 控制协商缓存的字段

## Last-Modified/If-Modified-Since 
`If-Modified-Since`是一个`请求首部字段`，并且只能用在`GET`或者`HEAD`请求中。`Last-Modified`是一个`响应首部字段`，包含服务器认定的资源作出修改的日期及时间。当带着If-Modified-Since头访问服务器请求资源时，服务器会检查Last-Modified，如果Last-Modified的时间早于或等于If-Modified-Since则会返回一个不带主体的304响应，否则将重新返回资源。

## ETag/If-None-Match 
`ETag`是一个`响应首部字段`，它是根据实体内容生成的一段hash字符串，标识资源的状态，由服务端产生。`If-None-Match`是一个条件式的`请求首部`。如果请求资源时在请求首部加上这个字段，值为之前服务器端返回的资源上的ETag，则当且仅当服务器上没有任何资源的ETag属性值与这个首部中列出的时候，服务器才会返回带有所请求资源实体的200响应，否则服务器会返回不带实体的304响应。ETag优先级比Last-Modified高，同时存在时会以ETag为准。

![](https://tva1.sinaimg.cn/large/0081Kckwly1gk7e7k298oj30ws0aymy0.jpg)

ETag属性之间的比较采用的是`弱比较算法`，即两个文件除了每个比特都相同外，内容一致也可以认为是相同的。例如，如果两个页面仅仅在页脚的生成时间有所不同，就可以认为二者是相同的。

因为`ETag`的特性，所以相较于`Last-Modified`有一些优势：

1.  某些情况下服务器`无法获取资源的最后修改时间`
2.  资源的最后修改时间变了但是内容没变，使用ETag可以`正确缓存`
3.  如果资源修改非常频繁，在秒以下的时间进行修改，`Last-Modified`只能精确到秒